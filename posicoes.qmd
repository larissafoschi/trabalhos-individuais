import os
import requests
from dotenv import load_dotenv

load_dotenv(".env")

TOKEN = os.getenv("SPTRANS_TOKEN")
CODIGO_LINHA = os.getenv("SPTRANS_CODIGO_LINHA", "35274")

if not TOKEN:
    raise RuntimeError("SPTRANS_TOKEN não definido em .env")

s = requests.Session()
login_res = s.post(f"http://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={TOKEN}")
if not login_res.ok or login_res.text.strip().lower() != "true":
    raise RuntimeError(f"Falha ao autenticar: {login_res.status_code} {login_res.text}")

pos_res = s.get(f"http://api.olhovivo.sptrans.com.br/v2.1/Posicao/Linha?codigoLinha={CODIGO_LINHA}")
pos_res.raise_for_status()

pos = pos_res.json()

if isinstance(pos, dict) and pos.get("vs"):
    print(f"Foram encontrados {len(pos['vs'])} ônibus circulando.")
else:
    print("Nenhum ônibus em movimento no momento.")
print(pos)